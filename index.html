<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Kho Hàng - Hệ Thống Kho Thất Lạc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1rem 0; }
        .card { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; border-radius: 10px; }
        .btn-custom { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; color: white; }
        .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        .table th { background-color: #e9ecef; font-weight: 600; }
        .modal-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 10px 10px 0 0; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; }
        .nav-tabs .nav-link.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        #stockChart, #statusChart { max-height: 400px; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .role-badge { font-size: 0.8em; }
        .tab-content .form-control.is-invalid { border-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Login/Register Modal (Hiển thị đầu tiên) -->
    <div class="modal fade show d-block" id="authModal" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-user-shield"></i> Xác Thực Hệ Thống</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs: Login / Register -->
                    <ul class="nav nav-tabs" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Đăng Nhập</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">Đăng Ký</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <!-- Tab Đăng Nhập -->
                        <div class="tab-pane fade show active" id="login" role="tabpanel">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label">Tên Đăng Nhập <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="loginUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mật Khẩu <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Đăng Nhập</button>
                                </div>
                            </form>
                        </div>
                        <!-- Tab Đăng Ký -->
                        <div class="tab-pane fade" id="register" role="tabpanel">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label class="form-label">Tên Đăng Nhập <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="regUsername" required minlength="3">
                                    <div class="invalid-feedback">Tên đăng nhập phải unique và ít nhất 3 ký tự!</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mật Khẩu <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="regPassword" required minlength="6">
                                    <div class="invalid-feedback">Mật khẩu phải ít nhất 6 ký tự!</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Xác Nhận Mật Khẩu <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="regConfirmPassword" required minlength="6">
                                    <div class="invalid-feedback">Mật khẩu xác nhận không khớp!</div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">Đăng Ký</button>
                                </div>
                                <div class="alert alert-info mt-2 small">
                                    <i class="fas fa-info-circle"></i> Tài khoản mới sẽ có vai trò "Người Xem" (chỉ xem dữ liệu). Admin và Manager được cấp riêng.
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Nội dung chính (Ẩn ban đầu) -->
    <div id="mainContent" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h1><i class="fas fa-warehouse"></i> Hệ Thống Quản Lý Kho Hàng Pro (Final Project)</h1>
                        <small class="opacity-75" id="roleDisplay">Đăng nhập để tiếp tục...</small>
                    </div>
                    <div class="col-md-8 text-end">
                        <span class="me-3" id="roleBadge"></span>
                        <button class="btn btn-light me-2" id="loadSampleBtn" onclick="loadSampleData()"><i class="fas fa-seedling"></i> Load Dữ Liệu Mẫu</button>
                        <button class="btn btn-light me-2" id="exportPDFBtn" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Xuất PDF Báo Cáo</button>
                        <button class="btn btn-light me-2" id="clearAllBtn" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> Xóa Tất Cả</button>
                        <button class="btn btn-outline-light" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container mt-4">
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-selected="true">Sản Phẩm</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Nhập/Xuất Kho</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">Báo Cáo</button>
                </li>
            </ul>
            <div class="tab-content">
                <!-- Tab 1: Sản Phẩm -->
                <div class="tab-pane fade show active" id="products" role="tabpanel">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stats-card text-center p-3">
                                <h3 id="totalProducts">0</h3>
                                <p><i class="fas fa-boxes"></i> Tổng Sản Phẩm</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card text-center p-3">
                                <h3 id="totalValue">0 VNĐ</h3>
                                <p><i class="fas fa-money-bill-wave"></i> Tổng Giá Trị Kho</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card text-center p-3">
                                <h3 id="lowStock">0</h3>
                                <p><i class="fas fa-exclamation-triangle"></i> Hàng Ít (≤10)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card text-center p-3">
                                <h3 id="outOfStock">0</h3>
                                <p><i class="fas fa-ban"></i> Hết Hàng</p>
                            </div>
                        </div>
                    </div>
                    <!-- Controls -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <button class="btn btn-custom" id="addProductBtn" data-bs-toggle="modal" data-bs-target="#productModal" onclick="resetProductForm()">
                                        <i class="fas fa-plus"></i> Thêm Sản Phẩm
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="filterStatus" onchange="filterProducts()">
                                        <option value="">Tất Cả Trạng Thái</option>
                                        <option value="Đầy Đủ">Đầy Đủ</option>
                                        <option value="Ít">Ít</option>
                                        <option value="Hết">Hết</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm..." onkeyup="searchProducts()">
                                        <button class="btn btn-outline-secondary"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="productsTable">
                                    <thead>
                                        <tr>
                                            <th>Mã SP</th>
                                            <th>Tên SP</th>
                                            <th>Số Lượng</th>
                                            <th>Giá Nhập (VNĐ)</th>
                                            <th>Giá Bán (VNĐ)</th>
                                            <th>Trạng Thái</th>
                                            <th>Hành Động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsBody"></tbody>
                                </table>
                            </div>
                            <nav class="mt-3"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                        </div>
                    ẹ</div>
                </div>
                <!-- Tab 2: Nhập/Xuất Kho -->
                <div class="tab-pane fade" id="transactions" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-success me-2" id="importBtn" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="setTransactionType('import')">
                                        <i class="fas fa-arrow-down"></i> Nhập Kho
                                    </button>
                                    <button class="btn btn-danger" id="exportBtn" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="setTransactionType('export')">
                                        <i class="fas fa-arrow-up"></i> Xuất Kho
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <input type="date" class="form-control" id="dateFilter" onchange="filterTransactions()" max="">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="transactionsTable">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Mã SP</th>
                                            <th>Tên SP</th>
                                            <th>Loại</th>
                                            <th>Số Lượng</th>
                                            <th>Ghi Chú</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Tab 3: Báo Cáo -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header"><h6><i class="fas fa-chart-bar"></i> Biểu Đồ Tồn Kho</h6></div>
                                <div class="card-body">
                                    <canvas id="stockChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header"><h6><i class="fas fa-chart-pie"></i> Phân Bố Trạng Thái</h6></div>
                                <div class="card-body">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h6><i class="fas fa-file-alt"></i> Báo Cáo Chi Tiết (Tháng Này)</h6></div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead><tr><th>Sản Phẩm</th><th>Nhập</th><th>Xuất</th><th>Tồn Cuối</th><th>Giá Trị (VNĐ)</th></tr></thead>
                                <tbody id="reportBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Sản Phẩm -->
    <div class="modal fade" id="productModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Thêm Sản Phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label class="form-label">Mã SP <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productCode" required maxlength="20">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên SP <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Giá Nhập (VNĐ) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productImportPrice" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Giá Bán (VNĐ) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productSellPrice" min="0" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-custom" id="saveProductBtn" onclick="saveProduct()">Lưu</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Giao Dịch -->
    <div class="modal fade" id="transactionModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Nhập Kho</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <input type="hidden" id="transactionType">
                        <div class="mb-3">
                            <label class="form-label">Chọn Sản Phẩm <span class="text-danger">*</span></label>
                            <select class="form-select" id="transactionProduct" required onchange="updateQuantityLimit()">
                                <option value="">-- Chọn --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Lượng <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="transactionQuantity" min="1" required>
                            <small id="quantityLimit" class="text-muted"></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi Chú</label>
                            <textarea class="form-control" id="transactionNote" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-custom" id="saveTransactionBtn" onclick="saveTransaction()">Xác Nhận</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let products = [];
        let transactions = [];
        let users = [];
        let currentPage = 1, itemsPerPage = 10;
        let filteredProducts = [], filteredTransactions = [];
        let stockChart, statusChart;
        let currentRole = null, currentUser = null;
        // Quyền hạn: Admin full, Manager hạn chế (không load sample, clear all), Viewer chỉ xem + export
        const roles = {
            admin: { canAdd: true, canEdit: true, canDelete: true, canTransaction: true, canLoadSample: true, canClearAll: true, canExport: true },
            manager: { canAdd: true, canEdit: true, canDelete: true, canTransaction: true, canLoadSample: false,
